name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json

    - name: Set up Docker Buildx
      uses: actions/docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Log in to Docker Hub (optional)
      if: env.DOCKER_USERNAME && env.DOCKER_PASSWORD
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Create .env file
      run: |
        cat > .env << EOF
        # Database Configuration
        POSTGRES_DB=${{ secrets.POSTGRES_DB }}
        POSTGRES_USER=${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_HOST=postgres
        POSTGRES_PORT=5432

        # JWT Configuration
        JWT_SECRET=${{ secrets.JWT_SECRET }}

        # Email Configuration
        EMAIL_SERVICE=${{ secrets.EMAIL_SERVICE }}
        EMAIL_HOST=${{ secrets.EMAIL_HOST }}
        EMAIL_PORT=${{ secrets.EMAIL_PORT }}
        EMAIL_FROM=${{ secrets.EMAIL_FROM }}
        EMAIL_FROM_NAME=${{ secrets.EMAIL_FROM_NAME }}
        EMAIL_USER=${{ secrets.EMAIL_USER }}
        EMAIL_PASS=${{ secrets.EMAIL_PASS }}

        # Client Configuration
        CLIENT_URL=${{ secrets.CLIENT_URL }}
        NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}

        # Next.js Configuration
        NEXT_SERVER_ACTIONS_ENCRYPTION_KEY=${{ secrets.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY }}

        # Environment
        NODE_ENV=production
        EOF

    - name: Make build script executable
      run: chmod +x build.sh

    - name: Run build
      run: |
        export CI=true
        ./build.sh

    - name: Start services
      run: docker compose up -d

    - name: Health check
      run: |
        echo "Waiting for services to be healthy..."
        sleep 15

        # Check PostgreSQL health
        echo "Checking PostgreSQL..."
        docker compose exec -T postgres pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} || (echo "PostgreSQL health check failed" && exit 1)

        # Check backend health
        echo "Checking backend API..."
        timeout=60
        while [ $timeout -gt 0 ]; do
          if curl -f http://localhost:5000/api/v1/health >/dev/null 2>&1; then
            echo "‚úÖ Backend API is healthy"
            break
          fi
          sleep 2
          timeout=$((timeout - 2))
        done

        if [ $timeout -le 0 ]; then
          echo "‚ùå Backend API health check failed"
          exit 1
        fi

        # Check frontend health
        echo "Checking frontend..."
        timeout=30
        while [ $timeout -gt 0 ]; do
          if curl -f http://localhost:3000/ >/dev/null 2>&1; then
            echo "‚úÖ Frontend is healthy"
            break
          fi
          sleep 2
          timeout=$((timeout - 2))
        done

        if [ $timeout -le 0 ]; then
          echo "‚ùå Frontend health check failed"
          exit 1
        fi

        echo "üéâ All services are healthy!"

    - name: Show deployment status
      if: success()
      run: |
        echo "================================================================================"
        echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "================================================================================"
        echo ""
        echo "üåê Application URLs:"
        echo "   Frontend:    http://localhost:3000"
        echo "   API:         http://localhost:5000/api/v1"
        echo "   Health:      http://localhost:5000/api/v1/health"
        echo ""
        echo "üîß Docker Commands:"
        echo "   View logs:        docker compose logs -f"
        echo "   View backend logs: docker compose logs -f backend"
        echo "   View frontend logs: docker compose logs -f frontend"
        echo "   Stop services:    docker compose down"
        echo "   Restart services: docker compose restart"
        echo ""

    - name: Show deployment status on failure
      if: failure()
      run: |
        echo "================================================================================"
        echo "‚ùå DEPLOYMENT FAILED!"
        echo "================================================================================"
        echo ""
        echo "üîç Debugging Information:"
        echo "   View all logs:        docker compose logs"
        echo "   View backend logs:    docker compose logs backend"
        echo "   View frontend logs:    docker compose logs frontend"
        echo "   Check running containers: docker ps -a"
        echo "   Check container status: docker compose ps"
        echo ""
        docker compose logs
        exit 1
