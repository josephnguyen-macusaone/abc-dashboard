# Repo secrets: Settings ‚Üí Secrets and variables ‚Üí Actions
name: Build and Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create .env file for build
      run: |
        cat > .env << EOF
        # Environment
        NODE_ENV=production

        # Database Configuration
        POSTGRES_DB=${{ secrets['POSTGRES_DB'] }}
        POSTGRES_USER=${{ secrets['POSTGRES_USER'] }}
        POSTGRES_PASSWORD=${{ secrets['POSTGRES_PASSWORD'] }}
        POSTGRES_HOST=postgres
        POSTGRES_PORT=5432
        DATABASE_URL=postgresql://${{ secrets['POSTGRES_USER'] }}:${{ secrets['POSTGRES_PASSWORD'] }}@postgres:5432/${{ secrets['POSTGRES_DB'] }}

        # JWT Configuration
        JWT_SECRET=${{ secrets['JWT_SECRET'] }}
        JWT_EXPIRES_IN=24h
        JWT_REFRESH_EXPIRES_IN=7d
        JWT_ISSUER=abc-dashboard
        JWT_EMAIL_VERIFICATION_EXPIRES_IN=24h
        JWT_PASSWORD_RESET_EXPIRES_IN=10m

        # Email Configuration (Mailjet Production)
        EMAIL_SERVICE=${{ secrets['EMAIL_SERVICE'] }}
        EMAIL_HOST=${{ secrets['EMAIL_HOST'] }}
        EMAIL_PORT=${{ secrets['EMAIL_PORT'] }}
        EMAIL_SECURE=false
        EMAIL_FROM=${{ secrets['EMAIL_FROM'] }}
        EMAIL_FROM_NAME=${{ secrets['EMAIL_FROM_NAME'] }}
        EMAIL_USER=${{ secrets['EMAIL_USER'] }}
        EMAIL_PASS=${{ secrets['EMAIL_PASS'] }}

        # External License API
        EXTERNAL_LICENSE_API_URL=${{ secrets['EXTERNAL_LICENSE_API_URL'] }}
        EXTERNAL_LICENSE_API_KEY=${{ secrets['EXTERNAL_LICENSE_API_KEY'] }}

        # Client Configuration
        CLIENT_URL=${{ secrets['CLIENT_URL'] }}

        # Frontend Configuration (CRITICAL: baked into build)
        # Production uses relative API paths (/api/v1)
        # OpenLiteSpeed proxies https://portal.abcsalon.us/api/v1/* to backend:5000
        # DO NOT set NEXT_PUBLIC_API_URL - it overrides relative mode
        NEXT_PUBLIC_USE_RELATIVE_API=true
        NEXT_SERVER_ACTIONS_ENCRYPTION_KEY=${{ secrets['NEXT_SERVER_ACTIONS_ENCRYPTION_KEY'] }}

        # Security
        BCRYPT_ROUNDS=12
        ENCRYPTION_KEY=${{ secrets['ENCRYPTION_KEY'] }}

        # Cache Configuration
        CACHE_USER_DATA_TTL=1800
        CACHE_API_RESPONSE_TTL=300

        # Redis
        REDIS_URL=redis://redis:6379
        REDIS_ENABLED=true
        CACHE_TYPE=redis

        # Scheduled Jobs
        SCHEDULED_JOBS_ENABLED=true
        LICENSE_STATUS_JOB_RUN_ON_STARTUP=true
        LICENSE_SYNC_SCHEDULE=*/10 * * * *
        LICENSE_SYNC_ENABLED=true
        EOF

    - name: Build Docker images
      run: |
        echo "=========================================="
        echo "Building for branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.event.head_commit.message }}"
        echo "Author: ${{ github.event.head_commit.author.name }}"
        echo "=========================================="
        echo ""

        echo "üîß Building backend..."
        docker compose build backend

        echo "üöÄ Building frontend..."
        docker compose build frontend

        echo "‚úÖ Build complete"
        docker images | grep abc-license

    - name: Save images to compressed archives
      run: |
        mkdir -p dist

        echo "üíæ Saving backend image..."
        docker save abc-license-backend:latest | gzip > dist/backend.tar.gz

        echo "üíæ Saving frontend image..."
        docker save abc-license-frontend:latest | gzip > dist/frontend.tar.gz

        echo "‚úÖ Images saved"
        ls -lh dist/

    - name: Install SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets['SERVER_SSH_KEY'] }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets['SERVER_HOST'] }} >> ~/.ssh/known_hosts

    - name: Transfer images to server
      run: |
        echo "üì§ Transferring images to server..."
        scp -i ~/.ssh/deploy_key dist/backend.tar.gz dist/frontend.tar.gz ${{ secrets['SERVER_USER'] }}@${{ secrets['SERVER_HOST'] }}:/root/abc-dashboard/dist/
        echo "‚úÖ Transfer complete"

    - name: Deploy on server
      env:
        BRANCH: ${{ github.ref_name }}
        COMMIT_MSG: ${{ github.event.head_commit.message }}
        COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
      run: |
        echo "üöÄ Deploying on server..."
        ssh -i ~/.ssh/deploy_key ${{ secrets['SERVER_USER'] }}@${{ secrets['SERVER_HOST'] }} << ENDSSH
          cd /root/abc-dashboard

          echo "=========================================="
          echo "üöÄ Deployment Information"
          echo "=========================================="
          echo "Branch:  $BRANCH"
          echo "Commit:  $COMMIT_MSG"
          echo "Author:  $COMMIT_AUTHOR"
          echo "Time:    \$(date)"
          echo "=========================================="
          echo ""

          echo "üì¶ Loading images..."
          docker load < dist/backend.tar.gz
          docker load < dist/frontend.tar.gz

          echo ""
          echo "üîç Verifying images..."
          docker images | grep abc-license | head -5

          echo ""
          echo "üöÄ Starting services..."
          docker compose up -d

          echo ""
          echo "‚è≥ Waiting for services to stabilize..."
          sleep 15

          echo ""
          echo "üìä Container status:"
          docker compose ps

          echo ""
          echo "‚úÖ Deployment complete!"
        ENDSSH

    - name: Verify deployment
      run: |
        echo "üîç Verifying deployment..."
        ssh -i ~/.ssh/deploy_key ${{ secrets['SERVER_USER'] }}@${{ secrets['SERVER_HOST'] }} << 'ENDSSH'
          cd /root/abc-dashboard

          # Wait for backend health check
          timeout=60
          echo "Checking backend health..."
          while [ $timeout -gt 0 ]; do
            if docker compose exec -T backend curl -f http://localhost:5000/api/v1/health >/dev/null 2>&1; then
              echo "‚úÖ Backend is healthy"
              break
            fi
            sleep 2
            timeout=$((timeout - 2))
          done

          if [ $timeout -le 0 ]; then
            echo "‚ö†Ô∏è Backend health check timeout"
            docker compose logs backend --tail 50
          fi

          # Check frontend
          echo "Checking frontend..."
          if docker compose exec -T frontend wget --quiet --tries=1 --spider http://localhost:3000/ 2>&1; then
            echo "‚úÖ Frontend is healthy"
          else
            echo "‚ö†Ô∏è Frontend may still be starting"
            docker compose logs frontend --tail 50
          fi

          echo ""
          echo "üìä Container status:"
          docker compose ps
        ENDSSH

    - name: Cleanup
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key
        rm -rf dist/

    - name: Deployment summary
      if: success()
      run: |
        echo "================================================================================"
        echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "================================================================================"
        echo ""
        echo "üîÄ Branch:   ${{ github.ref_name }}"
        echo "üìù Commit:   ${{ github.event.head_commit.message }}"
        echo "üë§ Author:   ${{ github.event.head_commit.author.name }}"
        echo "üìÖ Time:     $(date)"
        echo ""
        echo "üåê Application URLs:"
        echo "   Frontend:    http://${{ secrets['SERVER_HOST'] }}:3000"
        echo "   API:         http://${{ secrets['SERVER_HOST'] }}:5000/api/v1"
        echo "   Health:      http://${{ secrets['SERVER_HOST'] }}:5000/api/v1/health"
        echo ""
        echo "üîß Useful commands:"
        echo "   View logs:    ssh ${{ secrets['SERVER_USER'] }}@${{ secrets['SERVER_HOST'] }} 'cd /root/abc-dashboard && docker compose logs -f'"
        echo "   Check status: ssh ${{ secrets['SERVER_USER'] }}@${{ secrets['SERVER_HOST'] }} 'cd /root/abc-dashboard && docker compose ps'"
        echo "   Restart:      ssh ${{ secrets['SERVER_USER'] }}@${{ secrets['SERVER_HOST'] }} 'cd /root/abc-dashboard && docker compose restart'"
        echo ""

    - name: Deployment failed
      if: failure()
      run: |
        echo "================================================================================"
        echo "‚ùå DEPLOYMENT FAILED!"
        echo "================================================================================"
        echo ""
        echo "üîç Check the logs above for details"
        echo "   SSH to server: ssh ${{ secrets['SERVER_USER'] }}@${{ secrets['SERVER_HOST'] }}"
        echo "   View logs: cd /root/abc-dashboard && docker compose logs"
        echo ""
        exit 1
