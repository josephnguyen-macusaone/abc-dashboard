<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ABC Dashboard Backend</title>
    <link rel="stylesheet" href="/dashboard.css" />
  </head>
  <body>
    <div class="main-content">
      <div class="container">
        <div class="header">
          <h1>ABC Dashboard Backend</h1>
          <p>Modern REST API with Authentication</p>
          <div class="health-score" id="health-score">
            <span class="score-value">100</span>
            <span class="score-label">Health Score</span>
          </div>
        </div>

        <div class="actions">
          <a href="/api-docs" class="btn">API Documentation</a>
          <a href="/api/v1/health" class="btn secondary" target="_blank">Raw Health Check</a>
          <button
            class="btn tertiary refresh-btn"
            id="refresh-btn"
            onclick="updateDashboard()"
            title="Refresh dashboard (Press R)"
          >
            <span class="refresh-icon" id="refresh-icon">‚ü≥</span>
            <span class="refresh-text" id="refresh-text">Refresh</span>
          </button>
        </div>

        <!-- Row 1: Core Status -->
        <div class="dashboard">
          <div class="card">
            <h3>üñ•Ô∏è System Status</h3>
            <div class="metric">
              <span class="metric-label">Status</span>
              <span class="status healthy" id="system-status">OK</span>
            </div>
            <div class="metric">
              <span class="metric-label">Environment</span>
              <span class="metric-value" id="system-environment">development</span>
            </div>
            <div class="metric">
              <span class="metric-label">Uptime</span>
              <span class="metric-value" id="system-uptime">0h 0m</span>
            </div>
            <div class="metric">
              <span class="metric-label">Node Version</span>
              <span class="metric-value" id="node-version">-</span>
            </div>
          </div>

          <div class="card">
            <h3>‚ö° Performance</h3>
            <div class="metric">
              <span class="metric-label">Total Requests</span>
              <span class="metric-value" id="performance-requests">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Avg Response</span>
              <span class="metric-value" id="performance-response-time">0ms</span>
            </div>
            <div class="metric">
              <span class="metric-label">P95 Response</span>
              <span class="metric-value" id="performance-p95">0ms</span>
            </div>
            <div class="metric">
              <span class="metric-label">Error Rate</span>
              <span class="metric-value" id="performance-error-rate">0%</span>
            </div>
          </div>

          <div class="card">
            <h3>üíæ Resources</h3>
            <div class="metric">
              <span class="metric-label">Memory</span>
              <div class="progress-bar">
                <div class="progress" id="memory-progress" style="width: 0%"></div>
              </div>
              <span class="metric-value" id="performance-memory">0%</span>
            </div>
            <div class="metric">
              <span class="metric-label">CPU</span>
              <div class="progress-bar">
                <div class="progress cpu" id="cpu-progress" style="width: 0%"></div>
              </div>
              <span class="metric-value" id="performance-cpu">0%</span>
            </div>
            <div class="metric">
              <span class="metric-label">Load Average</span>
              <span class="metric-value" id="load-average">-</span>
            </div>
          </div>

          <div class="card">
            <h3>üóÑÔ∏è Database</h3>
            <div class="metric">
              <span class="metric-label">Connection</span>
              <span class="status healthy" id="db-connection">Connected</span>
            </div>
            <div class="metric">
              <span class="metric-label">Database</span>
              <span class="metric-value" id="db-name">abc_dashboard</span>
            </div>
            <div class="metric">
              <span class="metric-label">Collections</span>
              <span class="metric-value" id="db-collections">-</span>
            </div>
            <div class="metric">
              <span class="metric-label">Objects</span>
              <span class="metric-value" id="db-objects">-</span>
            </div>
          </div>
        </div>

        <!-- Row 2: Monitoring -->
        <div class="dashboard">
          <div class="card">
            <h3>üö® Error Monitoring</h3>
            <div class="metric">
              <span class="metric-label">Status</span>
              <span class="status healthy" id="error-status">Healthy</span>
            </div>
            <div class="metric">
              <span class="metric-label">Total Errors</span>
              <span class="metric-value" id="error-total">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Recent Errors</span>
              <span class="metric-value" id="error-recent">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Error Score</span>
              <span class="metric-value" id="error-score">100</span>
            </div>
          </div>

          <div class="card">
            <h3>üîí Security</h3>
            <div class="metric">
              <span class="metric-label">Failed Logins</span>
              <span class="metric-value" id="security-failed-logins">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Rate Limited</span>
              <span class="metric-value" id="security-rate-limited">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Blocked IPs</span>
              <span class="metric-value" id="security-blocked-ips">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Suspicious</span>
              <span class="metric-value" id="security-suspicious">0</span>
            </div>
          </div>

          <div class="card">
            <h3>üì¶ Cache</h3>
            <div class="metric">
              <span class="metric-label">Type</span>
              <span class="metric-value" id="cache-type">in-memory</span>
            </div>
            <div class="metric">
              <span class="metric-label">Hit Rate</span>
              <span class="metric-value" id="cache-hit-rate">0%</span>
            </div>
            <div class="metric">
              <span class="metric-label">Connected</span>
              <span class="status" id="cache-connected">No</span>
            </div>
          </div>

          <div class="card">
            <h3>üë• Application</h3>
            <div class="metric">
              <span class="metric-label">Active Users</span>
              <span class="metric-value" id="app-active-users">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Endpoints</span>
              <span class="metric-value" id="app-endpoints">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Platform</span>
              <span class="metric-value" id="app-platform">-</span>
            </div>
            <div class="metric">
              <span class="metric-label">Hostname</span>
              <span class="metric-value truncate" id="app-hostname">-</span>
            </div>
          </div>
        </div>

        <!-- Row 3: Services & Config -->
        <div class="dashboard">
          <div class="card wide">
            <h3>üîå Services Status</h3>
            <div class="services-grid" id="services-grid">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <div class="card">
            <h3>‚öôÔ∏è Configuration</h3>
            <div class="metric">
              <span class="metric-label">PORT</span>
              <span class="metric-value" id="config-port">5000</span>
            </div>
            <div class="metric">
              <span class="metric-label">JWT Secret</span>
              <span class="metric-value" id="config-jwt">‚úÖ Set</span>
            </div>
            <div class="metric">
              <span class="metric-label">MongoDB</span>
              <span class="metric-value" id="config-mongodb">‚úÖ Set</span>
            </div>
            <div class="metric">
              <span class="metric-label">Bcrypt Rounds</span>
              <span class="metric-value" id="config-bcrypt">14</span>
            </div>
          </div>
        </div>

        <!-- Last Updated -->
        <div class="last-updated">
          Last updated: <span id="last-updated">-</span>
          <span class="auto-refresh">Auto-refresh: 10s</span>
        </div>
      </div>
    </div>

    <div class="bottom-section">
      <div class="container">
        <div class="footer">
          <p>Built with Express.js, MongoDB, and modern JavaScript</p>
        </div>
      </div>
    </div>

    <script>
      let isRefreshing = false;
      let refreshInterval = null;

      // Fetch health data and update the dashboard
      async function updateDashboard(showFeedback = true) {
        // Prevent multiple simultaneous refreshes
        if (isRefreshing) {
          return;
        }

        isRefreshing = true;
        const refreshBtn = document.getElementById('refresh-btn');
        const refreshIcon = document.getElementById('refresh-icon');
        const refreshText = document.getElementById('refresh-text');

        if (showFeedback) {
          refreshBtn.classList.add('refreshing');
          refreshIcon.classList.add('spinning');
          refreshText.textContent = 'Refreshing...';
          refreshBtn.disabled = true;
        }

        try {
          const startTime = Date.now();
          const response = await fetch('/api/v1/health');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();

          // Update health score
          const scoreElement = document.querySelector('.score-value');
          const healthScoreEl = document.getElementById('health-score');
          scoreElement.textContent = data.score || 100;
          healthScoreEl.className = `health-score ${getScoreClass(data.score || 100)}`;

          // Update system status
          const statusElement = document.getElementById('system-status');
          statusElement.textContent = data.status?.toUpperCase() || 'UNKNOWN';
          statusElement.className = `status ${data.status === 'healthy' ? 'healthy' : 'degraded'}`;

          document.getElementById('system-environment').textContent =
            data.environment || 'development';
          document.getElementById('node-version').textContent = data.version || '-';

          // Calculate uptime
          const uptimeSeconds = data.system?.uptime || 0;
          const days = Math.floor(uptimeSeconds / 86400);
          const hours = Math.floor((uptimeSeconds % 86400) / 3600);
          const minutes = Math.floor((uptimeSeconds % 3600) / 60);
          document.getElementById('system-uptime').textContent =
            days > 0 ? `${days}d ${hours}h ${minutes}m` : `${hours}h ${minutes}m`;

          // Update performance metrics
          document.getElementById('performance-requests').textContent = formatNumber(
            data.legacyMetrics?.totalRequests || 0
          );
          document.getElementById('performance-response-time').textContent =
            `${Math.round(data.legacyMetrics?.averageResponseTime || 0)}ms`;
          document.getElementById('performance-p95').textContent =
            `${data.legacyMetrics?.p95ResponseTime || 0}ms`;
          document.getElementById('performance-error-rate').textContent =
            `${data.legacyMetrics?.errorRate || 0}%`;

          // Update resource metrics
          const memoryPercent = parseFloat(data.system?.memoryUsagePercent || 0);
          const cpuPercent = parseFloat(data.system?.cpuUsagePercent || 0);

          document.getElementById('performance-memory').textContent =
            `${Math.round(memoryPercent)}%`;
          document.getElementById('memory-progress').style.width =
            `${Math.min(memoryPercent, 100)}%`;
          document.getElementById('memory-progress').className =
            `progress ${getResourceClass(memoryPercent)}`;

          document.getElementById('performance-cpu').textContent = `${cpuPercent.toFixed(1)}%`;
          document.getElementById('cpu-progress').style.width = `${Math.min(cpuPercent, 100)}%`;
          document.getElementById('cpu-progress').className =
            `progress cpu ${getResourceClass(cpuPercent)}`;

          // Load average
          const loadAvg = data.system?.loadAverage;
          if (loadAvg && loadAvg.length > 0) {
            document.getElementById('load-average').textContent = loadAvg
              .map((l) => l.toFixed(2))
              .join(' / ');
          }

          // Update database status
          const dbConnectionElement = document.getElementById('db-connection');
          dbConnectionElement.textContent = data.database?.connected ? 'Connected' : 'Disconnected';
          dbConnectionElement.className = `status ${data.database?.connected ? 'healthy' : 'degraded'}`;

          document.getElementById('db-name').textContent = data.database?.name || 'abc_dashboard';
          document.getElementById('db-collections').textContent = data.database?.collections || '-';
          document.getElementById('db-objects').textContent = formatNumber(
            data.database?.objects || 0
          );

          // Update error monitoring
          const errorStatus = document.getElementById('error-status');
          errorStatus.textContent = (data.errorMonitoring?.status || 'healthy').toUpperCase();
          errorStatus.className = `status ${data.errorMonitoring?.status === 'healthy' ? 'healthy' : 'degraded'}`;

          document.getElementById('error-total').textContent =
            data.errorMonitoring?.totalErrors || 0;
          document.getElementById('error-recent').textContent =
            data.errorMonitoring?.recentErrorsCount || 0;
          document.getElementById('error-score').textContent = data.errorMonitoring?.score || 100;

          // Update security
          const security = data.application?.securityEvents || {};
          document.getElementById('security-failed-logins').textContent =
            security.failedLogins || 0;
          document.getElementById('security-rate-limited').textContent =
            security.rateLimitedRequests || 0;
          document.getElementById('security-blocked-ips').textContent = security.blockedIPs || 0;
          document.getElementById('security-suspicious').textContent =
            security.suspiciousActivities || 0;

          // Update cache
          document.getElementById('cache-type').textContent = data.cache?.type || 'in-memory';
          document.getElementById('cache-hit-rate').textContent = `${data.cache?.hitRate || 0}%`;
          const cacheConnected = document.getElementById('cache-connected');
          cacheConnected.textContent = data.cache?.connected ? 'Yes' : 'No';
          cacheConnected.className = `status ${data.cache?.connected ? 'healthy' : ''}`;

          // Update application
          document.getElementById('app-active-users').textContent =
            data.application?.activeUsers || 0;
          document.getElementById('app-endpoints').textContent =
            data.application?.endpointCount || 0;
          document.getElementById('app-platform').textContent = data.system?.platform || '-';
          document.getElementById('app-hostname').textContent = data.system?.hostname || '-';

          // Update services grid
          updateServicesGrid(data.gracefulDegradation?.features || {});

          // Update configuration
          document.getElementById('config-port').textContent = data.config?.port || '5000';
          document.getElementById('config-jwt').textContent =
            data.config?.jwtSecret || '‚ùå Missing';
          document.getElementById('config-mongodb').textContent =
            data.config?.mongodbUri || '‚ùå Missing';
          document.getElementById('config-bcrypt').textContent = data.config?.bcryptRounds || '14';

          // Update timestamp
          const updateTime = new Date().toLocaleTimeString();
          document.getElementById('last-updated').textContent = updateTime;

          // Show success feedback
          if (showFeedback) {
            const duration = Date.now() - startTime;
            refreshText.textContent = `Updated (${duration}ms)`;
            refreshBtn.classList.add('success');
            setTimeout(() => {
              refreshBtn.classList.remove('success');
              refreshText.textContent = 'Refresh';
            }, 2000);
          }
        } catch (error) {
          console.error('Failed to update dashboard:', error);
          document.getElementById('system-status').textContent = 'ERROR';
          document.getElementById('system-status').className = 'status degraded';

          // Show error feedback
          if (showFeedback) {
            refreshText.textContent = 'Error';
            refreshBtn.classList.add('error');
            setTimeout(() => {
              refreshBtn.classList.remove('error');
              refreshText.textContent = 'Refresh';
            }, 2000);
          }
        } finally {
          if (showFeedback) {
            refreshIcon.classList.remove('spinning');
            refreshBtn.disabled = false;
            refreshBtn.classList.remove('refreshing');
          }
          isRefreshing = false;
        }
      }

      function updateServicesGrid(features) {
        const grid = document.getElementById('services-grid');
        grid.innerHTML = '';

        const serviceIcons = {
          authentication: 'üîê',
          database: 'üóÑÔ∏è',
          email_service: 'üìß',
          file_upload: 'üìÅ',
          avatar_processing: 'üñºÔ∏è',
          cache: 'üíæ',
          metrics_collection: 'üìä',
          external_apis: 'üåê',
        };

        for (const [name, info] of Object.entries(features)) {
          const div = document.createElement('div');
          div.className = `service-item ${info.status === 'available' ? 'available' : 'unavailable'}`;
          div.innerHTML = `
            <span class="service-icon">${serviceIcons[name] || '‚öôÔ∏è'}</span>
            <span class="service-name">${formatServiceName(name)}</span>
            <span class="service-status ${info.status === 'available' ? 'healthy' : 'degraded'}">${info.status === 'available' ? '‚óè' : '‚óã'}</span>
          `;
          grid.appendChild(div);
        }
      }

      function formatServiceName(name) {
        return name.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
      }

      function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
      }

      function getScoreClass(score) {
        if (score >= 90) return 'excellent';
        if (score >= 75) return 'good';
        if (score >= 50) return 'warning';
        return 'critical';
      }

      function getResourceClass(percent) {
        if (percent >= 90) return 'critical';
        if (percent >= 75) return 'warning';
        return '';
      }

      // Update dashboard on page load and every 10 seconds
      updateDashboard(false); // Initial load without feedback

      // Auto-refresh (silent, no button feedback)
      refreshInterval = setInterval(() => {
        updateDashboard(false);
      }, 10000);

      // Keyboard shortcut: Press 'R' to refresh
      document.addEventListener('keydown', (e) => {
        // Only trigger if not typing in an input field
        if (
          e.key === 'r' &&
          e.target.tagName !== 'INPUT' &&
          e.target.tagName !== 'TEXTAREA' &&
          !e.ctrlKey &&
          !e.metaKey
        ) {
          e.preventDefault();
          updateDashboard();
        }
      });

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }
      });
    </script>
  </body>
</html>
